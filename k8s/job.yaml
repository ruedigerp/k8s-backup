# backup-rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backup-runner
  namespace: backup-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: backup-runner-role
rules:
- apiGroups: [""]
  resources: ["persistentvolumes", "persistentvolumeclaims", "pods", "serviceaccounts"]
  verbs: ["get", "list", "watch", "create", "delete"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "daemonsets", "replicasets"]
  verbs: ["get", "list", "patch"]
- apiGroups: ["batch"]
  resources: ["jobs"]
  verbs: ["create", "get", "list", "watch", "delete"]
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["clusterroles", "clusterrolebindings"]
  verbs: ["create", "get", "list", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: backup-runner-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: backup-runner-role
subjects:
- kind: ServiceAccount
  name: backup-runner
  namespace: backup-system

---
# backup-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: pv-backup-job
  namespace: backup-system
spec:
  template:
    spec:
      serviceAccountName: backup-runner
      restartPolicy: Never
      containers:
      - name: backup
        image: your-registry/k8s-pv-backup:latest
        env:
        - name: BACKUP_IMAGE
          value: "busybox:1.36"
        - name: NFS_SERVER
          value: "10.0.10.7"
        - name: NFS_PATH
          value: "/srv/nfs/k8s-pv/production/k8s-backup"
        - name: STORAGE_CLASS
          value: "nfs-client"
        - name: LOG_LEVEL
          value: "info"
        volumeMounts:
        - name: logs
          mountPath: /var/log/backup
      volumes:
      - name: logs
        emptyDir: {}

---
# backup-cronjob.yaml  
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pv-backup-cronjob
  namespace: backup-system
spec:
  schedule: "0 2 * * *"  # TÃ¤glich um 2 Uhr
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup-runner
          restartPolicy: Never
          containers:
          - name: backup
            image: ghcr.io/ruedigerp/k8s-pv-backup:latest
            env:
            - name: BACKUP_IMAGE
              value: "busybox:1.36"
            - name: NFS_SERVER
              valueFrom:
                configMapKeyRef:
                  name: backup-config
                  key: nfs-server
            - name: NFS_PATH
              valueFrom:
                configMapKeyRef:
                  name: backup-config
                  key: nfs-path
            - name: STORAGE_CLASS
              valueFrom:
                configMapKeyRef:
                  name: backup-config
                  key: storage-class
            - name: LOG_LEVEL
              value: "info"
            volumeMounts:
            - name: logs
              mountPath: /var/log/backup
          volumes:
          - name: logs
            emptyDir: {}

---
# backup-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-config
  namespace: backup-system
data:
  nfs-server: "10.0.10.7"
  nfs-path: "/srv/nfs/k8s-pv/production/k8s-backup"
  storage-class: "nfs-client"